<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asistente May Roga</title>
<meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">
<script src="https://js.stripe.com/v3/"></script>
<style>
body { font-family: Arial; background:#f5f5f5; display:flex; justify-content:center; padding-top:40px; }
.container { background:#fff; padding:30px; border-radius:12px; width:90%; max-width:600px; box-shadow:0 4px 15px rgba(0,0,0,0.1); }
h1 { text-align:center; color:#4CAF50; }
.service { border:1px solid #ddd; border-radius:10px; padding:15px; margin-bottom:15px; }
button { background:#4CAF50; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; margin-top:10px; }
button:hover { background:#43a047; }
#chat-output p { background:#eaf2fb; padding:8px; border-radius:8px; margin:5px 0; color:#2980b9; display:inline-block; }
#chat-input {
    width:80%;
    padding:8px;
    border-radius:6px;
    border:1px solid #ccc;
    color:#333; /* Letras del cliente en negro/gris */
}
#chat-send { padding:8px 16px; border-radius:6px; border:none; background:#4CAF50; color:white; cursor:pointer; }
#chat-send:hover { background:#43a047; }
#timer { text-align:center; margin-top:10px; font-size:1.2em; }
</style>
</head>
<body>
<div class="container">
<h1>Asistente May Roga</h1>

<div style="margin-bottom:20px; text-align:center;">
<input id="secret-input" type="password" placeholder="Ingresa tu c√≥digo secreto">
<button onclick="unlockAllServices()">Desbloquear Servicios</button>
</div>

<div id="services"></div>

<h2>Chat del Servicio</h2>
<div id="chat-output"></div>
<input id="chat-input" type="text" placeholder="Escribe tu mensaje">
<button id="chat-send" onclick="sendChat()">Enviar</button>
<div id="timer"></div>
</div>

<script>
const backendURL = "https://asistente-virtual-may-roga.onrender.com";
let currentService = null;
let userMsgs = [];

// --- Lista de servicios ---
const services = [
    {name:"Risoterapia y Bienestar Natural", price:12, duration:600},
    {name:"Hor√≥scopo y Consejos de Vida", price:6, duration:120},
    {name:"Respuesta R√°pida", price:2, duration:55},
    {name:"Servicio Personalizado", price:50, duration:1200},
    {name:"Servicio Corporativo", price:750, duration:1800},
    {name:"Servicio Grupal", price:450, duration:900}
];

const servicesDiv = document.getElementById("services");
services.forEach(s=>{
    const div=document.createElement('div');
    div.className='service';
    div.innerHTML=`<h2>${s.name}</h2><p>Precio: $${s.price}</p>
    <button onclick="startService('${s.name}')">Iniciar Chat</button>
    <button onclick="buyService('${s.name}',${s.price})">Comprar</button>`;
    servicesDiv.appendChild(div);
});

// --- Stripe Compra (abre en nueva pesta√±a) ---
async function buyService(product, amount){
    const res = await fetch(`${backendURL}/create-checkout-session`,{
        method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify({product, amount})
    });
    const data = await res.json();
    if(data.url){
        window.open(data.url, "_blank"); // üîë abre Stripe en nueva pesta√±a
    } else {
        alert("Error al crear sesi√≥n de pago");
    }
}

// --- Desbloqueo servicios ---
async function unlockAllServices(){
    const code=document.getElementById("secret-input").value.trim();
    if(!code){ alert("Ingresa tu c√≥digo"); return; }
    const res=await fetch(`${backendURL}/assistant-unlock`,{
        method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify({secret: code})
    });
    const data = await res.json();
    if(data.success) alert("Servicios desbloqueados ‚úÖ");
    else alert("C√≥digo incorrecto ‚ùå");
}

// --- Inicio servicio ---
function startService(serviceName){
    currentService = serviceName;
    userMsgs = [];
    document.getElementById("chat-output").innerHTML=`<p>Conectando con ${serviceName}...</p>`;
}

// --- Funci√≥n para hablar con voz del navegador ---
function speakText(text){
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = "es-ES";
    speechSynthesis.speak(utterance);
}

// --- Enviar mensaje ---
async function sendChat(){
    const input = document.getElementById("chat-input");
    const msg = input.value.trim();
    if(!msg || !currentService) return;

    const out = document.getElementById("chat-output");
    const p = document.createElement('p'); p.textContent="T√∫: "+msg;
    p.style.color = "#333"; // Color de letras del cliente
    out.appendChild(p);
    input.value="";
    userMsgs.push(msg);

    try {
        const res = await fetch(`${backendURL}/assistant-stream-message`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({service: currentService, messages: userMsgs})
        });
        const data = await res.json();

        // Contenedor con respuesta y bot√≥n de voz
        const divResp = document.createElement('div');
        const p2 = document.createElement('p'); p2.textContent=data.answer;
        const btn = document.createElement('button');
        btn.textContent = "üîä Escuchar";
        btn.style.marginLeft = "10px";
        btn.onclick = () => speakText(data.answer);

        divResp.appendChild(p2);
        divResp.appendChild(btn);

        out.appendChild(divResp);
        out.scrollTop = out.scrollHeight;
    } catch(err){
        const p2 = document.createElement('p'); p2.textContent="Error al generar respuesta.";
        out.appendChild(p2);
        out.scrollTop = out.scrollHeight;
    }
}
</script>
</body>
</html>
