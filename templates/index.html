let evtSource = null;
let currentService = null;
let userMsgs = [];

// --- Inicio servicio ---
function startService(serviceName){
    currentService = serviceName;
    userMsgs = [];
    if(evtSource) evtSource.close();
    document.getElementById("chat-output").innerHTML=`<p>Conectando con ${serviceName}...</p>`;

    // Abrimos SSE para recibir respuestas continuas
    evtSource = new EventSource(`${backendURL}/assistant-stream?service=${encodeURIComponent(currentService)}`);
    
    evtSource.onmessage = (e)=>{
        const p=document.createElement('p');
        p.textContent=e.data;
        document.getElementById("chat-output").appendChild(p);
        document.getElementById("chat-output").scrollTop = document.getElementById("chat-output").scrollHeight;
    };
    
    evtSource.onerror = ()=>{
        evtSource.close();
        const p=document.createElement('p');
        p.textContent="Sesión finalizada o desconectada";
        document.getElementById("chat-output").appendChild(p);
    };
}

// --- Enviar mensaje ---
function sendChat(){
    const input = document.getElementById("chat-input");
    const msg = input.value.trim();
    if(!msg || !currentService) return;
    const out = document.getElementById("chat-output");
    const p = document.createElement('p'); 
    p.textContent="Tú: "+msg;
    out.appendChild(p);
    input.value="";

    // Guardamos mensajes enviados para enviarlos al backend
    userMsgs.push(msg);

    // Petición POST para que el backend genere la respuesta sin cerrar SSE
    fetch(`${backendURL}/assistant-stream-message`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({service: currentService, messages: userMsgs})
    });
}
