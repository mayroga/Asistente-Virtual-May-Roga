<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asistente May Roga</title>
<meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">
<script src="https://js.stripe.com/v3/"></script>
<style>
body { font-family: Arial, sans-serif; background:#f0f2f5; margin:0; display:flex; justify-content:center; align-items:flex-start; padding:20px; }
.container { background:#fff; padding:20px; border-radius:16px; width:100%; max-width:800px; box-shadow:0 6px 20px rgba(0,0,0,0.15); }
.title-box { background:#8e24aa; color:#fff; padding:15px; border-radius:12px; text-align:center; font-size:1.8em; font-weight:bold; margin-bottom:20px; border:2px solid #fff; box-shadow:0 4px 10px rgba(0,0,0,0.3); }
.service, .microservice { border-radius:12px; padding:15px; margin-bottom:15px; color:#fff; font-weight:bold; }
.service:nth-child(1){ background:#4CAF50; }
.service:nth-child(2){ background:#ff9800; }
.service:nth-child(3){ background:#9c27b0; }
.service:nth-child(4){ background:#2196F3; }
.service:nth-child(5){ background:#f44336; }
.service:nth-child(6){ background:#009688; }
.service h2, .microservice h2 { margin:0 0 5px 0; }
.service p, .microservice p { margin:4px 0; }
button { background:#fff; color:#333; border:none; padding:8px 16px; border-radius:8px; cursor:pointer; margin-top:8px; font-weight:bold; }
button:hover { background:#e0e0e0; }
#chat-output { margin-top:20px; max-height:300px; overflow-y:auto; padding:10px; border:1px solid #ddd; border-radius:10px; background:#fafafa; }
#chat-output p { padding:8px; border-radius:8px; margin:6px 0; max-width:80%; word-wrap:break-word; }
#chat-output p.client { background:#e0e0e0; color:#000; align-self:flex-start; }
#chat-output p.assistant { background:#eaf2fb; color:#2980b9; align-self:flex-end; }
#chat-box { display:flex; margin-top:10px; }
#chat-input { flex:1; padding:10px; border-radius:8px; border:1px solid #ccc; color:#000; }
#chat-send { margin-left:10px; padding:10px 18px; border-radius:8px; border:none; background:#2980b9; color:#fff; cursor:pointer; }
#chat-send:hover { background:#1f6391; }
#timer { text-align:center; margin-top:15px; font-size:1.2em; font-weight:bold; color:#d32f2f; }
.microservice p.english { font-size:0.85em; color:#eee; margin-top:-2px; }
</style>
</head>
<body>
<div class="container">
<div class="title-box">Asistente May Roga</div>

<h2 style="color:#2980b9; margin-top:10px;">Chat del Servicio</h2>
<div id="chat-output"></div>
<div id="chat-box">
    <input id="chat-input" type="text" placeholder="Escribe tu mensaje">
    <button id="chat-send" onclick="sendChat()">Enviar</button>
</div>
<div id="timer"></div>

<div style="margin:20px 0; text-align:center;">
<input id="secret-input" type="password" placeholder="Ingresa tu c√≥digo secreto">
<button onclick="unlockAllServices()">Desbloquear Servicios</button>
</div>

<div id="services"></div>

<script>
const backendURL = "https://asistente-virtual-may-roga.onrender.com";
let currentService = null;
let userMsgs = [];
let timerInterval;

const services = [
    {name:"Risoterapia y Bienestar Natural", english:"Laughter Therapy & Natural Wellness", price:8, duration:300},
    {name:"Servicio Express", english:"Express Service", price:3, duration:48},
    {name:"HOROSCOPO Y CONSEJOS DE VIDA", english:"Horoscope & Life Advice", price:6, duration:80}
];

const microservices = [
    {name:"Risa Rel√°mpago", english:"Lightning Laugh", price:3.99, duration:120},
    {name:"T√© M√°gico en 2 Minutos", english:"Magic Tea in 2 Minutes", price:3.99, duration:120},
    {name:"Confianza Instant√°nea", english:"Instant Confidence", price:3.99, duration:120},
    {name:"Energ√≠a Flash", english:"Flash Energy", price:3.99, duration:120},
    {name:"Calma Expr√©s", english:"Express Calm", price:3.99, duration:120},
    {name:"Optimismo R√°pido", english:"Quick Optimism", price:3.99, duration:120},
    {name:"Abundancia en Minutos", english:"Abundance in Minutes", price:3.99, duration:120},
    {name:"Poder Instant√°neo", english:"Instant Power", price:3.99, duration:120},
    {name:"Inspiraci√≥n Express", english:"Express Inspiration", price:3.99, duration:120},
    {name:"Amor Rel√°mpago", english:"Lightning Love", price:3.99, duration:120},
    {name:"Batido Energ√©tico Verde", english:"Green Energy Shake", price:3.99, duration:120},
    {name:"Mini Gu√≠a Natural", english:"Mini Natural Guide", price:3.99, duration:120},
    {name:"Reto de 3 D√≠as", english:"3-Day Challenge", price:3.99, duration:120},
    {name:"Relajaci√≥n Breve", english:"Short Relaxation", price:3.99, duration:120},
    {name:"Tracker de Bienestar", english:"Wellness Tracker", price:3.99, duration:120},
    {name:"Claridad Mental Expr√©s", english:"Express Mental Clarity", price:3.99, duration:120},
    {name:"Esperanza R√°pida", english:"Quick Hope", price:3.99, duration:120},
    {name:"Confianza y Autoestima", english:"Confidence & Self-Esteem", price:3.99, duration:120},
    {name:"Amor y Conexi√≥n", english:"Love & Connection", price:3.99, duration:120},
    {name:"Paz Interior", english:"Inner Peace", price:3.99, duration:120},
    {name:"Diversi√≥n Expr√©s", english:"Express Fun", price:3.99, duration:120},
    {name:"Sentido de Poder", english:"Sense of Power", price:3.99, duration:120},
    {name:"Inspiraci√≥n Instant√°nea", english:"Instant Inspiration", price:3.99, duration:120},
    {name:"Mini Diagn√≥stico", english:"Mini Assessment", price:3.99, duration:120},
    {name:"Receta Verde R√°pida", english:"Quick Green Recipe", price:3.99, duration:120}
];

const servicesDiv = document.getElementById("services");

services.forEach(s=>{
    const div = document.createElement('div');
    div.className='service';
    div.innerHTML=`<h2>${s.name}</h2>
                   <p class="english">[English: ${s.english}]</p>
                   <p>Precio: $${s.price}</p>
                   <p>Duraci√≥n: ${Math.floor(s.duration/60)}:${(s.duration%60).toString().padStart(2,'0')} min</p>
                   <button onclick="startService('${s.name}', ${s.duration})">Iniciar Chat</button>
                   <button onclick="buyService('${s.name}',${s.price})">Comprar</button>`;
    servicesDiv.appendChild(div);
});

microservices.forEach(m=>{
    const div = document.createElement('div');
    div.className='microservice';
    div.innerHTML=`<h2>${m.name}</h2>
                   <p class="english">[English: ${m.english}]</p>
                   <p>Precio: $${m.price}</p>
                   <p>Duraci√≥n: ${Math.floor(m.duration/60)}:${(m.duration%60).toString().padStart(2,'0')} min</p>
                   <button onclick="startService('${m.name}', ${m.duration})">Iniciar Chat</button>
                   <button onclick="buyService('${m.name}',${m.price})">Comprar</button>`;
    servicesDiv.appendChild(div);
});

function speakText(text){
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = "es-ES";
    speechSynthesis.speak(utterance);
}

function formatTime(seconds){
    const m = Math.floor(seconds/60);
    const s = seconds%60;
    return `${m}:${s.toString().padStart(2,'0')} min`;
}

let timerInterval;
function startTimer(duration){
    clearInterval(timerInterval);
    let timeLeft = duration;
    const timerDiv = document.getElementById("timer");
    timerDiv.textContent = formatTime(timeLeft);
    timerInterval = setInterval(()=>{
        timeLeft--;
        timerDiv.textContent = formatTime(timeLeft);
        if(timeLeft <= 0){
            clearInterval(timerInterval);
            timerDiv.textContent = "‚è∞ Tiempo finalizado";
        }
    },1000);
}

function startService(serviceName, duration){
    currentService = serviceName;
    userMsgs = [];
    document.getElementById("chat-output").innerHTML=`<p class="assistant">Conectando con ${serviceName}...</p>`;
    startTimer(duration);
}

async function buyService(product, amount){
    const res = await fetch(`${backendURL}/create-checkout-session`,{
        method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify({product, amount})
    });
    const data = await res.json();
    if(data.url){ window.open(data.url, "_blank"); } 
    else { alert("Error al crear sesi√≥n de pago"); }
}

async function unlockAllServices(){
    const code=document.getElementById("secret-input").value.trim();
    if(!code){ alert("Ingresa tu c√≥digo"); return; }
    const res=await fetch(`${backendURL}/assistant-unlock`,{
        method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify({secret: code})
    });
    const data = await res.json();
    alert(data.success ? "Servicios desbloqueados ‚úÖ" : "C√≥digo incorrecto ‚ùå");
}

async function sendChat(){
    const input = document.getElementById("chat-input");
    const msg = input.value.trim();
    if(!msg || !currentService) return;

    const out = document.getElementById("chat-output");
    const p = document.createElement('p');
    p.textContent="T√∫: "+msg;
    p.className="client";
    out.appendChild(p);
    input.value="";
    userMsgs.push(msg);

    try {
        const res = await fetch(`${backendURL}/assistant-stream-message`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({service: currentService, messages: userMsgs})
        });
        const data = await res.json();

        const divResp = document.createElement('div');
        const p2 = document.createElement('p');
        p2.textContent=data.answer;
        p2.className="assistant";

        const btn = document.createElement('button');
        btn.textContent = "üîä Escuchar";
        btn.style.marginLeft = "10px";
        btn.onclick = () => speakText(data.answer);

        divResp.appendChild(p2);
        divResp.appendChild(btn);

        out.appendChild(divResp);
        out.scrollTop = out.scrollHeight;
    } catch(err){
        const p2 = document.createElement('p');
        p2.textContent="Error al generar respuesta.";
        p2.className="assistant";
        out.appendChild(p2);
        out.scrollTop = out.scrollHeight;
    }
}
</script>
</div>
</body>
</html>
