<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente May Roga</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F3F4F6; }
        .message { max-width: 80%; padding: 1rem; border-radius: 1rem; margin-bottom: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); position: relative; }
        .user-message { background-color: #1F2937; color: #F9FAFB; align-self: flex-end; border-bottom-right-radius: 0; }
        .ai-message { background-color: #FFFFFF; color: #1F2937; align-self: flex-start; border-bottom-left-radius: 0; }
        .user-message::after { content: ""; position: absolute; bottom: 0; right: -10px; width: 0; height: 0; border-left: 10px solid #1F2937; border-bottom: 10px solid transparent; }
        .ai-message::after { content: ""; position: absolute; bottom: 0; left: -10px; width: 0; height: 0; border-right: 10px solid #FFFFFF; border-bottom: 10px solid transparent; }
        .loader { border: 4px solid rgba(0, 0, 0, 0.1); width: 24px; height: 24px; border-radius: 50%; border-left-color: #4B5563; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 10px; text-align: center; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }
    </style>
</head>
<body class="flex flex-col h-screen p-4 bg-gray-100">

    <!-- Modal de Disclaime (Aviso Legal) -->
    <div id="disclaimerModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">Aviso Legal</h2>
            <p class="text-sm text-gray-700">Este servicio es una herramienta de **Educación en Salud y Bienestar Natural**. No sustituye la atención médica profesional. Para diagnósticos y tratamientos, consulte a un médico con licencia. La información proporcionada es para fines educativos y no debe ser considerada como una prescripción médica.</p>
            <button class="bg-gray-800 text-white py-2 px-4 rounded-full hover:bg-gray-700 transition-colors mt-4" onclick="document.getElementById('disclaimerModal').style.display='none'; startFlow();">Aceptar y Continuar</button>
        </div>
    </div>

    <!-- Modal de Registro -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">Registro de Cliente</h2>
            <p class="text-gray-600 mb-4">Solo para sesiones grupales.</p>
            <form id="registerForm" class="flex flex-col space-y-4">
                <input type="text" id="nicknameInput" placeholder="Apodo/Sobrenombre" class="px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-gray-800">
                <input type="email" id="emailInput" placeholder="Correo electrónico" class="px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-gray-800">
                <input type="tel" id="phoneInput" placeholder="Teléfono" class="px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-gray-800">
                <input type="text" id="accessCodeInput" placeholder="Código de acceso (opcional)" class="px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-gray-800">
                <button type="submit" class="bg-gray-800 text-white py-2 px-4 rounded-full hover:bg-gray-700 transition-colors">Comenzar</button>
            </form>
        </div>
    </div>

    <!-- Modal de Servicios -->
    <div id="servicesModal" class="modal">
        <div class="modal-content text-left">
            <h2 class="text-2xl font-bold mb-4 text-center">Nuestros Servicios de Vida</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-gray-200 p-4 rounded-lg">
                    <h3 class="font-bold">Servicio Express de Vida</h3>
                    <p class="text-sm text-gray-700">$1 (55 Segundos)</p>
                    <button class="select-service-btn mt-2 bg-gray-800 text-white w-full py-1 rounded-full text-sm hover:bg-gray-700 transition-colors" data-service="Express" data-mode="individual">Individual</button>
                    <p class="text-sm text-gray-700 mt-2">Grupal: Escalado</p>
                    <button class="select-service-btn mt-2 bg-gray-800 text-white w-full py-1 rounded-full text-sm hover:bg-gray-700 transition-colors" data-service="Express" data-mode="grupal">Grupal</button>
                </div>
                <div class="bg-gray-200 p-4 rounded-lg">
                    <h3 class="font-bold">Risoterapia y Bienestar Natural</h3>
                    <p class="text-sm text-gray-700">$12 (10 Minutos)</p>
                    <button class="select-service-btn mt-2 bg-gray-800 text-white w-full py-1 rounded-full text-sm hover:bg-gray-700 transition-colors" data-service="Risoterapia" data-mode="individual">Individual</button>
                    <p class="text-sm text-gray-700 mt-2">Grupal: Escalado</p>
                    <button class="select-service-btn mt-2 bg-gray-800 text-white w-full py-1 rounded-full text-sm hover:bg-gray-700 transition-colors" data-service="Risoterapia" data-mode="grupal">Grupal</button>
                </div>
                <div class="bg-gray-200 p-4 rounded-lg">
                    <h3 class="font-bold">Horóscopo Express</h3>
                    <p class="text-sm text-gray-700">$3 (1 Minuto 30 Segundos)</p>
                    <button class="select-service-btn mt-2 bg-gray-800 text-white w-full py-1 rounded-full text-sm hover:bg-gray-700 transition-colors" data-service="Horoscopo" data-mode="individual">Individual</button>
                    <p class="text-sm text-gray-700 mt-2">Grupal: Escalado</p>
                    <button class="select-service-btn mt-2 bg-gray-800 text-white w-full py-1 rounded-full text-sm hover:bg-gray-700 transition-colors" data-service="Horoscopo" data-mode="grupal">Grupal</button>
                </div>
                <div class="bg-gray-200 p-4 rounded-lg">
                    <h3 class="font-bold">Minicurso de Idiomas</h3>
                    <p class="text-sm text-gray-700">$5 (8 Minutos)</p>
                    <button class="select-service-btn mt-2 bg-gray-800 text-white w-full py-1 rounded-full text-sm hover:bg-gray-700 transition-colors" data-service="Minicurso" data-mode="individual">Individual</button>
                    <p class="text-sm text-gray-700 mt-2">Grupal: Escalado</p>
                    <button class="select-service-btn mt-2 bg-gray-800 text-white w-full py-1 rounded-full text-sm hover:bg-gray-700 transition-colors" data-service="Minicurso" data-mode="grupal">Grupal</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para el pago de Stripe -->
    <div id="stripeModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">Confirmar Pago</h2>
            <div id="payment-element">
                <!-- Stripe Elements se inyectará aquí -->
            </div>
            <button id="stripeButton" class="bg-green-600 text-white py-2 px-4 rounded-full mt-4 hover:bg-green-500 transition-colors">Pagar</button>
            <div id="payment-message" class="mt-4 text-red-600 font-bold"></div>
        </div>
    </div>

    <!-- Contenedor principal de la aplicación -->
    <div class="flex-grow flex flex-col w-full max-w-3xl mx-auto bg-gray-200 rounded-lg shadow-xl overflow-hidden">
        <!-- Encabezado del chat -->
        <div class="bg-gray-800 text-white p-4 text-center rounded-t-lg">
            <h1 class="text-xl font-bold">Asistente May Roga</h1>
            <p id="statusMessage" class="text-sm font-light mt-1">¡Curando tu espíritu y guiando tu bienestar!</p>
        </div>

        <!-- Contenedor del temporizador (inicialmente oculto) -->
        <div id="timerContainer" class="hidden text-center p-4 bg-gray-800 text-white">
            <h3 class="text-sm font-light">Tiempo de servicio:</h3>
            <div id="timerDisplay" class="text-4xl font-extrabold mt-1">00:00</div>
        </div>

        <!-- Área de mensajes -->
        <div id="messages" class="flex-grow p-4 overflow-y-auto flex flex-col space-y-4">
            <div class="message ai-message">
                Hola, soy Asistente May Roga, ¡tu guía para el bienestar! Estoy aquí para curar tu espíritu y transformar cualquier situación en crecimiento. <br><br> Por favor, elige un servicio para comenzar.
            </div>
        </div>

        <!-- Pie de página con el formulario de entrada -->
        <div class="bg-gray-300 p-4 flex items-center rounded-b-lg">
            <button id="micButton" class="mr-2 bg-gray-800 text-white p-3 rounded-full shadow-lg hover:bg-gray-700 transition-colors" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 6v-1.5m-6 1.5a6 6 0 006-6v-1.5m-6 1.5A6 6 0 0112 3.75v10.5M12 18.75a6 6 0 006-6v-1.5m-6 6v-1.5m-6 1.5a6 6 0 00-6-6v-1.5m6 6v-1.5m-6 1.5A6 6 0 0112 3.75v10.5M12 21.75a9 9 0 100-18 9 9 0 000 18z" />
                </svg>
            </button>
            <input type="text" id="userInput" class="flex-grow px-4 py-2 rounded-full border-2 border-transparent focus:outline-none focus:border-gray-500 transition-colors" placeholder="Escribe o habla tu mensaje..." disabled>
            <button id="sendButton" class="ml-2 bg-gray-800 text-white p-3 rounded-full shadow-lg hover:bg-gray-700 transition-colors" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                </svg>
            </button>
            <button id="playButton" class="ml-2 bg-gray-800 text-white p-3 rounded-full shadow-lg hover:bg-gray-700 transition-colors" style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 12a9 9 0 1018 0 9 9 0 00-18 0z" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Stripe.js v3 -->
    <script src="https://js.stripe.com/v3/"></script>

    <script>
        // Configuración de la API y el sistema
        const STRIPE_PUBLIC_KEY = "pk_test_51PajfB04j4zK54mO2T1qO5d1J5E3R3L6L3N4h7R8E9f1A2c4E5g6h7i8j9k00z1x2y3x4y5z6a7b8c9d0e1f2g3h4i"; // Esta es una clave de prueba
        const stripe = Stripe(STRIPE_PUBLIC_KEY);

        const messagesDiv = document.getElementById('messages');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const micButton = document.getElementById('micButton');
        const playButton = document.getElementById('playButton');
        const statusMessage = document.getElementById('statusMessage');
        const disclaimerModal = document.getElementById('disclaimerModal');
        const registerModal = document.getElementById('registerModal');
        const registerForm = document.getElementById('registerForm');
        const servicesModal = document.getElementById('servicesModal');
        const selectServiceBtns = document.querySelectorAll('.select-service-btn');
        const stripeModal = document.getElementById('stripeModal');
        const stripeButton = document.getElementById('stripeButton');
        const paymentMessage = document.getElementById('payment-message');
        const timerContainer = document.getElementById('timerContainer');
        const timerDisplay = document.getElementById('timerDisplay');
        const speechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const synth = window.speechSynthesis;
        const recognition = speechRecognition ? new speechRecognition() : null;

        const serviceTimers = {
            'Express': 55,
            'Risoterapia': 600,
            'Horoscopo': 90,
            'Minicurso': 480,
        };

        let chatHistory = [];
        let isRegistered = false;
        let selectedService = '';
        let selectedMode = '';
        let isSessionActive = false;
        let userName = '';
        let lastAiMessage = '';
        let timerInterval = null;
        let timerDuration = 0;
        let elements;

        // Función para mostrar un mensaje en la interfaz
        function displayMessage(text, isUser) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.classList.add(isUser ? 'user-message' : 'ai-message');
            messageElement.textContent = text;
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Función para mostrar un modal de mensaje
        function showMessage(title, text) {
            const modal = document.createElement('div');
            modal.classList.add('modal');
            modal.innerHTML = `
                <div class="modal-content">
                    <h2 class="text-2xl font-bold mb-4">${title}</h2>
                    <p class="text-sm text-gray-700">${text}</p>
                    <button class="bg-gray-800 text-white py-2 px-4 rounded-full hover:bg-gray-700 transition-colors mt-4" onclick="this.closest('.modal').remove()">Cerrar</button>
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'block';
        }

        // Flujo de interacción inicial
        function startFlow() {
            servicesModal.style.display = 'block';
        }

        selectServiceBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                selectedService = btn.getAttribute('data-service');
                selectedMode = btn.getAttribute('data-mode');
                servicesModal.style.display = 'none';

                if (selectedMode === 'grupal') {
                    registerModal.style.display = 'block';
                } else {
                    handlePayment();
                }
            });
        });

        registerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const nickname = document.getElementById('nicknameInput').value;
            const email = document.getElementById('emailInput').value;
            const phone = document.getElementById('phoneInput').value;

            if (nickname && email && phone) {
                userName = nickname;
                isRegistered = true;
                registerModal.style.display = 'none';
                displayMessage(`¡Hola, ${userName}! Gracias por registrarte. Ahora, procesaremos el pago para activar tu sesión.`, false);
                handlePayment();
            } else {
                showMessage("Error de Registro", "Por favor, completa todos los campos para el registro.");
            }
        });

        async function handlePayment() {
            try {
                // Iniciar la creación del PaymentIntent en el backend
                const accessCode = document.getElementById('accessCodeInput').value;
                const response = await fetch('/create-payment-intent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        service: selectedService,
                        access_code: accessCode
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    const clientSecret = data.client_secret;

                    if (clientSecret === "free_access") {
                        startSession();
                        return;
                    }

                    // Mostrar el modal de Stripe y el formulario de pago
                    stripeModal.style.display = 'block';
                    elements = stripe.elements({ clientSecret });
                    const paymentElement = elements.create('payment');
                    paymentElement.mount('#payment-element');

                    // Manejar el clic en el botón de pago
                    stripeButton.addEventListener('click', async () => {
                        stripeButton.disabled = true;
                        const { error } = await stripe.confirmPayment({
                            elements,
                            confirmParams: {
                                return_url: window.location.href, // Redirige a la misma página
                            },
                        });

                        if (error) {
                            paymentMessage.textContent = error.message;
                            stripeButton.disabled = false;
                        } else {
                            // La redirección manejará la confirmación del pago
                        }
                    });
                } else {
                    showMessage("Error", "Error al iniciar el proceso de pago: " + data.error);
                }
            } catch (error) {
                console.error("Error de pago:", error);
                showMessage("Error", "Ocurrió un error inesperado al procesar el pago.");
            }
        }

        function startSession() {
            stripeModal.style.display = 'none';
            isSessionActive = true;
            statusMessage.textContent = `Sesión activa: ${selectedService} (${selectedMode})`;

            const duration = serviceTimers[selectedService];
            if (duration) {
                let introMessage = '';
                if (selectedService === 'Risoterapia') {
                    introMessage = `¡Excelente! Vamos a empezar con Risoterapia. Por favor, ponte cómodo, cierra los ojos y respira hondo. Ahora, en los próximos ${Math.floor(duration/60)} minutos, intenta reír de forma natural. Te daré tiempo para hacerlo.`;
                } else {
                    introMessage = `¡Excelente! Estamos listos para comenzar tu ${selectedService}. Tienes ${Math.floor(duration/60)}:${String(duration % 60).padStart(2, '0')} minutos de servicio. Te daré espacio para que te concentres. El temporizador comenzará ahora.`;
                }
                displayMessage(introMessage, false);
                startServiceTimer(duration);
            } else {
                userInput.disabled = false;
                sendButton.disabled = false;
                micButton.disabled = false;
                displayMessage(`¡Excelente! Estamos listos para comenzar. ¿Qué tienes en mente hoy, ${userName}?`, false);
            }
        }

        // Lógica de temporizador para servicios con ejercicios
        function startServiceTimer(durationInSeconds) {
            timerDuration = durationInSeconds;
            timerContainer.classList.remove('hidden');
            sendButton.disabled = true;
            micButton.disabled = true;
            userInput.disabled = true;
            userInput.placeholder = "Ejercicio en curso...";

            timerInterval = setInterval(() => {
                const minutes = Math.floor(timerDuration / 60);
                const seconds = timerDuration % 60;
                timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                
                if (timerDuration <= 0) {
                    clearInterval(timerInterval);
                    timerContainer.classList.add('hidden');
                    onTimerComplete();
                } else {
                    timerDuration--;
                }
            }, 1000);
        }

        function onTimerComplete() {
            sendButton.disabled = false;
            micButton.disabled = false;
            userInput.disabled = false;
            userInput.placeholder = "Escribe o habla tu mensaje...";
            displayMessage("¡Tiempo! Espero que hayas disfrutado del ejercicio. ¿Cómo te sientes ahora? ¿Qué tal te fue?", false);
        }

        // Lógica de chat (ahora se comunica con el servidor)
        async function sendMessage() {
            const userText = userInput.value.trim();
            if (userText === '') return;

            displayMessage(userText, true);

            userInput.value = '';
            sendButton.disabled = true;
            micButton.disabled = true;

            const loaderElement = document.createElement('div');
            loaderElement.classList.add('loader');
            loaderElement.classList.add('ai-message');
            messagesDiv.appendChild(loaderElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            chatHistory.push({ role: "user", parts: [{ text: userText }] });

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: userText,
                        chat_history: chatHistory,
                        mode: selectedMode,
                        service: selectedService
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error de la API: ${response.statusText}`);
                }

                const data = await response.json();
                const aiResponse = data.response;

                messagesDiv.removeChild(loaderElement);
                
                displayMessage(aiResponse, false);
                lastAiMessage = aiResponse;
                playButton.style.display = 'block';
                chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                speak(aiResponse);

            } catch (error) {
                console.error("Error al comunicarse con el servidor:", error);
                messagesDiv.removeChild(loaderElement);
                displayMessage("Lo siento, hubo un error al procesar tu solicitud. Por favor, inténtalo de nuevo.", false);
            } finally {
                sendButton.disabled = false;
                micButton.disabled = false;
            }
        }

        // Funcionalidad de voz a texto
        if (recognition) {
            recognition.continuous = false;
            recognition.lang = 'es-ES';
            recognition.interimResults = false;

            micButton.addEventListener('click', () => {
                if (userInput.disabled) return;
                recognition.start();
                micButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 animate-pulse text-red-500"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 6v-1.5m-6 1.5a6 6 0 006-6v-1.5m-6 1.5A6 6 0 0112 3.75v10.5M12 18.75a6 6 0 006-6v-1.5m-6 6v-1.5m-6 1.5a6 6 0 00-6-6v-1.5m6 6v-1.5m-6 1.5A6 6 0 0112 3.75v10.5M12 21.75a9 9 0 100-18 9 9 0 000 18z" /></svg>`;
            });

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                userInput.value = transcript;
                sendMessage();
                micButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 6v-1.5m-6 1.5a6 6 0 006-6v-1.5m-6 1.5A6 6 0 0112 3.75v10.5M12 18.75a6 6 0 006-6v-1.5m-6 6v-1.5m-6 1.5a6 6 0 00-6-6v-1.5m6 6v-1.5m-6 1.5A6 6 0 0112 3.75v10.5M12 21.75a9 9 0 100-18 9 9 0 000 18z" /></svg>`;
            };

            recognition.onend = () => {
                micButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 6v-1.5m-6 1.5a6 6 0 006-6v-1.5m-6 1.5A6 6 0 0112 3.75v10.5M12 18.75a6 6 0 006-6v-1.5m-6 6v-1.5m-6 1.5a6 6 0 00-6-6v-1.5m6 6v-1.5m-6 1.5A6 6 0 0112 3.75v10.5M12 21.75a9 9 0 100-18 9 9 0 000 18z" /></svg>`;
            };
        } else {
            micButton.disabled = true;
            micButton.title = "El reconocimiento de voz no es compatible con este navegador.";
        }

        // Funcionalidad de texto a voz
        function speak(text) {
            if (synth.speaking) {
                synth.cancel();
            }
            const utteranceText = text.replace(/[*#]/g, '');
            const utterance = new SpeechSynthesisUtterance(utteranceText);
            utterance.lang = 'es-ES';
            synth.speak(utterance);
        }

        playButton.addEventListener('click', () => {
            if (lastAiMessage) {
                speak(lastAiMessage);
            }
        });

        // Event Listeners
        window.onload = () => {
            disclaimerModal.style.display = 'block';
        };

        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && !userInput.disabled) { sendMessage(); }
        });

        // Manejar redirección de Stripe
        document.addEventListener("DOMContentLoaded", async () => {
            const clientSecret = new URLSearchParams(window.location.search).get("payment_intent_client_secret");
            if (clientSecret) {
                const { paymentIntent } = await stripe.retrievePaymentIntent(clientSecret);
                if (paymentIntent.status === "succeeded") {
                    showMessage("Pago Exitoso", "¡El pago se ha completado con éxito! Tu sesión ha comenzado.");
                    startSession();
                } else {
                    showMessage("Pago Fallido", "El pago no se pudo completar. Por favor, inténtalo de nuevo.");
                }
            }
        });
    </script>
</body>
</html>
