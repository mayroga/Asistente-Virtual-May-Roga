<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente Virtual ¬∑ May Roga</title>
    <!-- Tailwind CSS para un dise√±o limpio y adaptable -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Stripe JS SDK para gestionar pagos -->
    <script src="https://js.stripe.com/v3/"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #f4f8f9;
            margin: 0;
            padding: 0;
            text-align: center;
            color: #333;
        }
        header {
            background: #00897B;
            color: white;
            padding: 20px;
            font-size: 1.5em;
            font-weight: bold;
        }
        .app-container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-width: 640px;
            margin: 20px auto;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 80vh;
        }
        .btn {
            display: block;
            width: 90%;
            margin: 10px auto;
            padding: 15px;
            font-size: 1.2em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: white;
            transition: opacity 0.3s;
        }
        .btn:hover { opacity: 0.9; }
        .btn-code { background: #0288d1; }
        .btn-stripe { background: #43a047; }
        .chat-message { padding: 10px 15px; border-radius: 15px; max-width: 80%; margin-bottom: 10px; line-height: 1.5; }
        .chat-message.user { background-color: #0288d1; color: white; align-self: flex-end; margin-left: auto; border-top-right-radius: 0; }
        .chat-message.system { background-color: #e0e0e0; color: #333; align-self: flex-start; margin-right: auto; border-top-left-radius: 0; }
        .chat-container { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; -ms-overflow-style: none; scrollbar-width: none; }
        .chat-container::-webkit-scrollbar { display: none; }
        .chat-input-area { display: flex; padding: 10px; border-top: 1px solid #ddd; }
        .chat-input { flex-grow: 1; border: 1px solid #ddd; border-radius: 20px; padding: 10px 15px; margin-right: 10px; }
        .chat-send-btn { background: #00897B; color: white; border: none; border-radius: 20px; padding: 10px 20px; cursor: pointer; }
        .loader { display: flex; align-items: center; justify-content: center; padding: 10px; color: #777; }
        .loader .spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-left-color: #00897B; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin-right: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<header>Asistente Virtual ¬∑ May Roga</header>

<div class="app-container">

    <div id="landingPage" class="p-5 flex flex-col justify-center items-center flex-grow">
        <h2 class="text-2xl font-bold mb-4">Elige un servicio</h2>
        <select id="serviceSelect" class="w-full max-w-sm p-3 mb-4 border rounded-lg shadow-sm">
            <option value="rapida">Agente de Respuesta R√°pida (55s - $2)</option>
            <option value="risoterapia">Risoterapia y Bienestar Natural (10 min - $12)</option>
            <option value="horoscopo">Hor√≥scopo (1 min 30s - $5)</option>
        </select>

        <div id="languageSelectDiv" class="w-full max-w-sm mb-4 hidden">
            <label for="languageSelect" class="block text-left mb-2 text-gray-700">Selecciona el idioma:</label>
            <select id="languageSelect" class="w-full p-3 border rounded-lg shadow-sm">
                <option value="es">Espa√±ol</option>
                <option value="en">English</option>
            </select>
        </div>

        <button id="stripePayBtn" class="btn btn-stripe">üí≥ Pagar con Stripe</button>

        <!-- Nuevo campo y bot√≥n para el c√≥digo secreto -->
        <div class="mt-8 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-2 text-gray-800">¬øTienes un c√≥digo secreto?</h3>
            <input type="text" id="codeInput" placeholder="Introduce tu c√≥digo" class="w-full p-3 mb-2 border rounded-lg shadow-sm" />
            <button id="codeBtn" class="btn btn-code">Acceder Gratis</button>
        </div>
    </div>

    <div id="servicePage" class="hidden flex-grow flex flex-col">
        <div class="bg-gray-100 p-4 text-center">
            <h2 id="serviceTitle" class="text-xl font-bold"></h2>
            <p id="timerDisplay" class="text-lg font-mono text-gray-600"></p>
        </div>

        <div id="chatInterface" class="hidden flex-grow flex flex-col">
            <div id="chatContainer" class="chat-container"></div>
            <div id="loadingMessage" class="loader hidden">
                <div class="spinner"></div>
                <span>May Roga est√° escribiendo...</span>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chatInput" placeholder="Escribe tu mensaje..." class="chat-input" />
                <button id="sendBtn" class="chat-send-btn">Enviar</button>
            </div>
        </div>

        <div id="voiceInterface" class="hidden flex-grow flex flex-col justify-center items-center p-8">
            <p id="currentVoiceText" class="text-2xl font-semibold text-gray-700 mb-8 text-center"></p>
            <div id="audioLoading" class="loader hidden mb-4">
                <div class="spinner"></div>
                <span>Generando audio...</span>
            </div>
            <div class="flex space-x-4">
                <button id="startAutoBtn" class="btn bg-blue-500 hover:bg-blue-600"><span class="mr-2">‚ñ∂Ô∏è</span> Iniciar Sesi√≥n Autom√°tica</button>
                <button id="startManualBtn" class="btn bg-green-500 hover:bg-green-600"><span class="mr-2">‚èØÔ∏è</span> Iniciar Sesi√≥n Manual</button>
            </div>
            <div id="manualControls" class="flex space-x-4 hidden mt-4">
                <button id="playStepBtn" class="btn bg-blue-500 hover:bg-blue-600"><span class="mr-2">‚ñ∂Ô∏è</span> Reproducir</button>
                <button id="nextStepBtn" class="btn bg-green-500 hover:bg-green-600"><span class="mr-2">‚è©</span> Siguiente Paso</button>
            </div>
            <button id="stopVoiceBtn" class="btn bg-red-500 hover:bg-red-600 mt-4">‚èπ Detener Sesi√≥n</button>
        </div>

        <div id="systemModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
                <h2 id="modalTitle" class="text-xl font-bold text-gray-800 mb-4"></h2>
                <p id="modalMessage" class="text-gray-600 mb-6"></p>
                <button id="modalCloseBtn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors duration-300">Aceptar</button>
            </div>
        </div>
    </div>
</div>

<footer>Disponible 24/7 ¬∑ Atenci√≥n profesional ¬∑ F√°cil y r√°pido</footer>

<script type="module">
    // --- Configuraci√≥n de Stripe y backend ---
    const stripe = Stripe('pk_live_51NqPxQBOA5mT4t0PEoRVRc0Sj7DugiHvxhozC3BYh0q0hAx1N3HCLJe4xEp3MSuNMA6mQ7fAO4mvtppqLodrtqEn00pgJNQaxz');
    const BACKEND_URL = 'https://asistente-virtual-may-roga.onrender.com';

    let currentService = null;
    let timerInterval = null;
    let timeLeft = 0;
    let chatHistory = [];
    let isServiceRunning = false;
    let currentStepIndex = 0;
    let currentAudio = null;
    let timeoutId = null;
    let currentLang = 'es';

    // Se define el c√≥digo secreto
    const SECRET_CODE = "MAYROGA2024";

    const landingPage = document.getElementById('landingPage');
    const servicePage = document.getElementById('servicePage');
    const serviceTitle = document.getElementById('serviceTitle');
    const timerDisplay = document.getElementById('timerDisplay');
    const chatInterface = document.getElementById('chatInterface');
    const chatContainer = document.getElementById('chatContainer');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const loadingMessage = document.getElementById('loadingMessage');
    const voiceInterface = document.getElementById('voiceInterface');
    const currentVoiceText = document.getElementById('currentVoiceText');
    const audioLoading = document.getElementById('audioLoading');
    const startAutoBtn = document.getElementById('startAutoBtn');
    const startManualBtn = document.getElementById('startManualBtn');
    const manualControls = document.getElementById('manualControls');
    const playStepBtn = document.getElementById('playStepBtn');
    const nextStepBtn = document.getElementById('nextStepBtn');
    const stopVoiceBtn = document.getElementById('stopVoiceBtn');
    const stripePayBtn = document.getElementById('stripePayBtn');
    const systemModal = document.getElementById('systemModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const serviceSelect = document.getElementById('serviceSelect');
    const languageSelect = document.getElementById('languageSelect');
    const languageSelectDiv = document.getElementById('languageSelectDiv');
    // Nuevas referencias a los elementos del c√≥digo secreto
    const codeInput = document.getElementById('codeInput');
    const codeBtn = document.getElementById('codeBtn');

    const services = {
        'rapida': {
            name: 'Agente de Respuesta R√°pida',
            duration: '55 segundos',
            price: '$2',
            durationInSeconds: 55,
            type: 'chat',
            prompt: {
                systemInstruction: `Eres May Roga, un agente de respuesta r√°pida. Tu objetivo es proporcionar una respuesta directa, √∫til y concisa en un m√°ximo de 2 a 4 frases. Debes incluir 1 acci√≥n siguiente concreta. El cierre debe ser "¬øDeseas algo m√°s?". Tu tono es profesional, emp√°tico, claro y limpio. No puedes dar diagn√≥sticos m√©dicos.`
            },
            initialMessage: 'Hola, ¬øen qu√© puedo ayudarte hoy? / Hello, how can I help you today?'
        },
        'risoterapia': {
            name: 'Risoterapia y Bienestar Natural',
            duration: '10 minutos',
            price: '$12',
            durationInSeconds: 600,
            type: 'voice',
            voiceName_es: 'Kore',
            voiceName_en: 'Zephyr',
            steps: {
                es: [
                    { texto: "¬°Hola! Bienvenido a tu sesi√≥n de risoterapia. Para comenzar, encuentra un lugar c√≥modo y si√©ntate o acu√©stese.", pausa: 5 },
                    { texto: "Ahora, cierra los ojos y respira profundamente. Inhala por la nariz...", pausa: 5 },
                    { texto: "y exhala por la boca. Repite esto tres veces.", pausa: 15 },
                    { texto: "Ahora, coloca tu mano sobre tu est√≥mago y respira, sintiendo c√≥mo se infla como un globo.", pausa: 10 },
                    { texto: "Es el momento de re√≠r. Comienza con una peque√±a sonrisa y deja que la risa surja de forma natural.", pausa: 20 },
                    { texto: "Puedes hacerlo. No te preocupes por el sonido. El objetivo es simplemente liberar la tensi√≥n.", pausa: 20 },
                    { texto: "Muy bien. Ahora, reduce tu risa a una risa silenciosa, moviendo solo los m√∫sculos de la cara.", pausa: 15 },
                    { texto: "Fant√°stico. Has completado el ejercicio. Abre los ojos lentamente cuando te sientas listo.", pausa: 10 },
                    { texto: "Recuerda que la risa es una herramienta poderosa. Vuelve a visitarnos cuando lo necesites. ¬°Has hecho un gran trabajo!", pausa: 0 }
                ],
                en: [
                    { texto: "Hello! Welcome to your laughter therapy session. To begin, find a comfortable place and sit or lie down.", pausa: 5 },
                    { texto: "Now, close your eyes and breathe deeply. Inhale through your nose...", pausa: 5 },
                    { texto: "and exhale through your mouth. Repeat this three times.", pausa: 15 },
                    { texto: "Now, place your hand on your stomach and breathe, feeling it inflate like a balloon.", pausa: 10 },
                    { texto: "It's time to laugh. Start with a small smile and let the laughter arise naturally.", pausa: 20 },
                    { texto: "You can do it. Don't worry about the sound. The goal is simply to release the tension.", pausa: 20 },
                    { texto: "Very well. Now, reduce your laughter to a silent one, moving only the muscles of your face.", pausa: 15 },
                    { texto: "Fantastic. You have completed the exercise. Open your eyes slowly when you feel ready.", pausa: 10 },
                    { texto: "Remember that laughter is a powerful tool. Come back and visit us whenever you need. You did a great job!", pausa: 0 }
                ]
            }
        },
        'horoscopo': {
            name: 'Hor√≥scopo',
            duration: '1 min 30s',
            price: '$5',
            durationInSeconds: 90,
            type: 'chat',
            prompt: {
                systemInstruction: `Eres un asistente de hor√≥scopo. Tu objetivo es proporcionar lecturas del hor√≥scopo. Debes responder de manera misteriosa y dar un consejo que inspire a tu usuario. Tu tono es m√≠stico y enigm√°tico. Solo respondes a preguntas sobre hor√≥scopos o el futuro.`
            },
            initialMessage: 'Bienvenido. ¬øQu√© misterio de tu futuro deseas que los astros te revelen hoy?'
        }
    };
    
    // --- L√≥gica de la UI ---
    function showModal(title, message, callback) {
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        systemModal.classList.remove('hidden');
        if (callback) {
            modalCloseBtn.onclick = () => {
                systemModal.classList.add('hidden');
                callback();
            };
        } else {
            modalCloseBtn.onclick = () => systemModal.classList.add('hidden');
        }
    }

    function switchPage(pageId) {
        landingPage.classList.add('hidden');
        servicePage.classList.add('hidden');
        document.getElementById(pageId).classList.remove('hidden');
    }

    function startService() {
        currentService = services[serviceSelect.value];
        serviceTitle.textContent = currentService.name;
        
        switchPage('servicePage');
        if (currentService.type === 'chat') {
            chatInterface.classList.remove('hidden');
            chatHistory = [{ role: 'system', parts: [{ text: currentService.initialMessage }] }];
            displayMessages();
        } else if (currentService.type === 'voice') {
            voiceInterface.classList.remove('hidden');
            manualControls.classList.add('hidden');
            currentLang = languageSelect.value;
        }

        // Inicia el temporizador
        timeLeft = currentService.durationInSeconds;
        timerDisplay.textContent = `Tiempo restante: ${formatTime(timeLeft)}`;
        timerInterval = setInterval(() => {
            timeLeft--;
            timerDisplay.textContent = `Tiempo restante: ${formatTime(timeLeft)}`;
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                stopVoiceSession();
                showModal('Tiempo Terminado', 'Tu sesi√≥n ha finalizado. Puedes volver a la p√°gina principal para elegir otro servicio.', () => {
                    location.reload();
                });
            }
        }, 1000);
    }
    
    // --- L√≥gica del pago con Stripe (ahora con llamada al backend) ---
    async function startCheckout() {
        const serviceId = serviceSelect.value;
        showModal('Procesando pago...', 'Conectando con el servicio de pagos. Por favor, espera.');
        
        try {
            const response = await fetch(`${BACKEND_URL}/create-checkout-session`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ serviceId: serviceId })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Error al crear la sesi√≥n de pago.');
            }

            const session = await response.json();

            // Redirigir al usuario a la p√°gina de pago de Stripe
            const result = await stripe.redirectToCheckout({
                sessionId: session.id,
            });

            if (result.error) {
                showModal('Error en el pago', result.error.message);
            }
        } catch (error) {
            console.error('Error durante el proceso de pago:', error);
            showModal('Error de Conexi√≥n', `Error: ${error.message}. Por favor, revisa la consola para m√°s detalles.`);
        }
    }

    // --- L√≥gica del c√≥digo secreto ---
    function checkSecretCode() {
        const codeEntered = codeInput.value.trim();
        if (codeEntered === SECRET_CODE) {
            showModal('C√≥digo Correcto', '¬°Acceso concedido! Disfruta de tu sesi√≥n gratuita.', startService);
        } else {
            showModal('C√≥digo Incorrecto', 'El c√≥digo que ingresaste no es v√°lido. Por favor, int√©ntalo de nuevo.');
        }
    }
    
    // --- Funciones de chat y voz ---
    function displayMessages() {
        chatContainer.innerHTML = '';
        chatHistory.forEach(message => {
            const messageElement = document.createElement('div');
            messageElement.classList.add('chat-message', message.role);
            messageElement.textContent = message.parts[0].text;
            chatContainer.appendChild(messageElement);
        });
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
    }

    // Funci√≥n de chat ahora simulada
    async function sendMessage() {
        const userMessage = chatInput.value.trim();
        if (!userMessage) return;

        chatInput.value = '';
        const userChat = { role: 'user', parts: [{ text: userMessage }] };
        chatHistory.push(userChat);
        displayMessages();

        loadingMessage.classList.remove('hidden');
        chatInput.disabled = true;
        sendBtn.disabled = true;

        try {
            // Se simula la respuesta de la IA
            await new Promise(resolve => setTimeout(resolve, 1500)); // Simula un retraso de 1.5 segundos
            
            const assistantMessage = { role: 'system', parts: [{ text: `¬°Hola! He recibido tu mensaje. Gracias por usar nuestro servicio. ¬øHay algo m√°s en lo que pueda ayudarte? (Esta es una respuesta de prueba simulada).` }] };
            chatHistory.push(assistantMessage);

        } catch (error) {
            console.error('Error al enviar mensaje:', error);
            const errorMessage = { role: 'system', parts: [{ text: 'Lo siento, hubo un error al procesar tu solicitud. Por favor, revisa la consola para m√°s detalles.' }] };
            chatHistory.push(errorMessage);
        } finally {
            loadingMessage.classList.add('hidden');
            chatInput.disabled = false;
            sendBtn.disabled = false;
            displayMessages();
            chatInput.focus();
        }
    }

    // Funci√≥n de voz ahora simulada
    async function playStep(step) {
        if (currentAudio) {
            currentAudio.pause();
            currentAudio.src = '';
        }
        audioLoading.classList.remove('hidden');
        currentVoiceText.textContent = step.texto;

        try {
            // Se simula la generaci√≥n del audio sin un backend
            await new Promise(resolve => setTimeout(resolve, 2000)); // Simula 2 segundos de generaci√≥n

            console.log(`[AUDIO SIMULADO] Reproduciendo: "${step.texto}"`);
            
            // Simular que el audio se ha reproducido para que la l√≥gica de la sesi√≥n autom√°tica contin√∫e
            const simulatedDuration = step.texto.length * 60; // Estimar duraci√≥n del audio
            
            setTimeout(() => {
                // Si la sesi√≥n es autom√°tica, pasa al siguiente paso
                if (isServiceRunning) {
                    currentStepIndex++;
                    if (currentStepIndex < currentService.steps[currentLang].length) {
                        timeoutId = setTimeout(() => {
                            playStep(currentService.steps[currentLang][currentStepIndex]);
                        }, currentService.steps[currentLang][currentStepIndex].pausa * 1000);
                    }
                }
            }, simulatedDuration);
            
        } catch (error) {
            console.error('Error al reproducir audio:', error);
            showModal('Error', 'No se pudo generar el audio. Por favor, int√©ntalo de nuevo m√°s tarde.');
        } finally {
            audioLoading.classList.add('hidden');
        }
    }

    function startAutoSession() {
        isServiceRunning = true;
        currentStepIndex = 0;
        playStep(currentService.steps[currentLang][currentStepIndex]);
        startAutoBtn.disabled = true;
        startManualBtn.disabled = true;
    }

    function startManualSession() {
        manualControls.classList.remove('hidden');
        startAutoBtn.disabled = true;
        startManualBtn.disabled = true;
        currentStepIndex = 0;
        currentVoiceText.textContent = currentService.steps[currentLang][currentStepIndex].texto;
    }

    function stopVoiceSession() {
        isServiceRunning = false;
        if (currentAudio) {
            currentAudio.pause();
            currentAudio.src = '';
        }
        if (timeoutId) {
            clearTimeout(timeoutId);
        }
    }
    
    // --- Event Listeners ---
    stripePayBtn.addEventListener('click', startCheckout);
    codeBtn.addEventListener('click', checkSecretCode);
    serviceSelect.addEventListener('change', (e) => {
      if (e.target.value === 'risoterapia') {
        languageSelectDiv.classList.remove('hidden');
      } else {
        languageSelectDiv.classList.add('hidden');
      }
    });

    sendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
    startAutoBtn.addEventListener('click', startAutoSession);
    startManualBtn.addEventListener('click', startManualSession);
    playStepBtn.addEventListener('click', () => playStep(currentService.steps[currentLang][currentStepIndex]));
    nextStepBtn.addEventListener('click', () => {
      currentStepIndex++;
      if (currentStepIndex < currentService.steps[currentLang].length) {
        currentVoiceText.textContent = currentService.steps[currentLang][currentStepIndex].texto;
      } else {
        showModal('Sesi√≥n Completada', 'Has completado todos los pasos de la sesi√≥n manual.', () => stopVoiceSession());
      }
    });
    stopVoiceBtn.addEventListener('click', () => {
        stopVoiceSession();
        location.reload();
    });

    // Funci√≥n para manejar el √©xito del pago
    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('payment_status') === 'success') {
            // Este es el flujo para cuando el usuario es redirigido de vuelta despu√©s de un pago exitoso
            showModal('Pago Exitoso', '¬°Tu pago ha sido procesado! Ahora puedes iniciar tu sesi√≥n.', startService);
            history.replaceState(null, '', window.location.pathname);
        }
    };
</script>

</body>
</html>
