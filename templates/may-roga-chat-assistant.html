<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asistente May Roga - SesiÃ³n Activa</title>
<style>
body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding-top:40px; display:flex; justify-content:center; }
.container { background:#fff; padding:30px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1); width:90%; max-width:600px; }
h1 { text-align:center; color:#4CAF50; margin-bottom:20px; }
#assistant-output { border:1px solid #ddd; border-radius:8px; padding:15px; min-height:250px; max-height:400px; overflow-y:auto; background:#fafafa; }
#timer { font-weight:bold; color:#f44336; margin-top:15px; text-align:center; font-size:18px; }
button { background:#4CAF50; color:#fff; border:none; padding:10px 20px; border-radius:8px; font-size:16px; cursor:pointer; margin-top:10px; }
button:hover { background:#43a047; }
.audio-btn { margin-top:5px; }
</style>
</head>
<body>

<div class="container">
<h1>Asistente May Roga ðŸŒ¿</h1>

<div id="assistant-output"></div>
<div id="timer"></div>
<button id="play-voice" class="audio-btn">Escuchar mensajes grabados ðŸ”Š</button>
</div>

<script>
const backendURL = "https://asistente-virtual-may-roga.onrender.com";
const urlParams = new URLSearchParams(window.location.search);
const sessionId = urlParams.get("session_id");
let currentService = null;
let timerInterval = null;
let audioQueue = [];

async function init(){
    try{
        // Obtener el servicio comprado
        const res = await fetch(`${backendURL}/get-session?session_id=${sessionId}`);
        const data = await res.json();
        currentService = data.product;
        startSSE(currentService);
    } catch(e){
        document.getElementById("assistant-output").innerText = "Error obteniendo la sesiÃ³n.";
    }
}

function startTimer(durationMinutes){
    clearInterval(timerInterval);
    let seconds = Math.ceil(durationMinutes * 60);
    const timerDiv = document.getElementById("timer");
    timerDiv.innerText = `Tiempo restante: ${seconds}s`;
    timerInterval = setInterval(()=> {
        seconds--;
        timerDiv.innerText = `Tiempo restante: ${seconds}s`;
        if(seconds <= 0){
            clearInterval(timerInterval);
            timerDiv.innerText = "SesiÃ³n finalizada âœ…";
        }
    },1000);
}

async function startSSE(service){
    // Obtener duraciÃ³n
    const durationRes = await fetch(`${backendURL}/get-duration?service=${service}`);
    const durationData = await durationRes.json();
    startTimer(durationData.duration);

    const evtSource = new EventSource(`${backendURL}/assistant-stream?service=${service}`);
    const output = document.getElementById("assistant-output");
    evtSource.onmessage = (e) => {
        const p = document.createElement("p");
        p.textContent = e.data;
        output.appendChild(p);
        output.scrollTop = output.scrollHeight;
        // Agregar mensaje a la cola de audio
        audioQueue.push(e.data);
    }
    evtSource.onerror = () => { evtSource.close(); }
}

// FunciÃ³n para reproducir TTS de los mensajes grabados
document.getElementById("play-voice").addEventListener("click", () => {
    if(audioQueue.length === 0) return;
    playNext(0);
});

function playNext(index){
    if(index >= audioQueue.length) return;
    const msg = audioQueue[index];
    const utter = new SpeechSynthesisUtterance(msg);
    utter.lang = "es-ES";
    utter.rate = 1;
    utter.pitch = 1;
    utter.onend = () => { playNext(index+1); }
    speechSynthesis.speak(utter);
}

init();
</script>

</body>
</html>
